CC=gcc
ARCH=$(shell uname -m)

CFLAGS = -g -O -Wall -D_GNU_SOURCE -std=c99
LDFLAGS= -lrt -lpthread
SRC1 = maqcafe.c fsm.c reactor.c fsm.h reactor.h
OBJ1 = maqcafe.o fsm.o task.o
SRC2 = maqcafe_time.c fsm.c fsm.h
OBJ2 = maqcafe_time.o fsm.o

all: $(OBJ1) $(OBJ2)
ifeq ($(ARCH), armv6l)
	$(CC) $(xeno-config --skin posix --cflags --ldflags) -o maqcafe $(OBJ1) $(LDFLAGS)
	$(CC) $(xeno-config --skin posix --cflags --ldflags) -o maqcafe_time $(OBJ2) $(LDFLAGS)
else
	$(CC) $(CFLAGS) -c $(SRC1)
	$(CC) $(CFLAGS) $(OBJ1) $(LDFLAGS) -o maqcafe
endif

clean:
	$(RM) $(OBJ1) $(OBJ2) maqcafe maqcafe_time

test: all
	./maqcafe < test/mcafe.input > test/mcafe.output

maqcafe_time: $(OBJ2)
	$(CC) $(xeno-config --skin posix --cflags --ldflags) -o maqcafe_time $(OBJ2) $(LDFLAGS)

time: maqcafe_time
	./maqcafe_time < test/mcafe.input > test/mcafe.output

debug: test
	gdb ./maqcafe < test/mcafe.input > test/mcafe.output

.PHONY: test time debug clean maqcafe_time
